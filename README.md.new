# AI Assistant v2.0 - Modern Architecture

–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å rule-based —Ä–æ—É—Ç–∏–Ω–≥–æ–º, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é –¥–∞–Ω–Ω—ã—Ö –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∞–º–∏.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–ª–æ–∏ —Å–∏—Å—Ç–µ–º—ã:
```
–ö–ª–∏–µ–Ω—Ç—ã (Telegram Bot, Web, Email)
    ‚Üì
LLM + Tools (classify, extract, route)
    ‚Üì
Services (Directory, Routing, Orchestrator)
    ‚Üì
Connectors (Google, Telegram, Notion)
    ‚Üì
Infrastructure (Postgres, Redis, Storage)
```

### –≠–≤–æ–ª—é—Ü–∏—è –ø–ª–∞–Ω–æ–≤:
- **MVP**: expenses/tasks/bookmarks ‚Üí Google Sheets + Telegram
- **Premium**: –±–æ–ª—å—à–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∫–æ–º–∞–Ω–¥—ã
- **Custom**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞, enterprise –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã

## üöÄ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å `records`
–í–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü transactions/tasks/ideas:
```sql
records(id, tenant_id, kind, title, body, amount, tags, assignee_member_id, meta)
```

### 2. Rule-based —Ä–æ—É—Ç–∏–Ω–≥
```json
{
  "match": {"kind": "expense", "amount": {">": 1000}},
  "actions": [
    {"connector": "telegram_dm", "target": "@accountant"},
    {"connector": "google_sheets", "target": "spreadsheet_id!Expenses"}
  ]
}
```

### 3. LLM Tools –∫–æ–Ω—Ç—Ä–∞–∫—Ç
```javascript
// –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- resolve_person(name) ‚Üí member_id, tg_chat_id
- add_expense/task/bookmark(data) ‚Üí record_id + routing
- search(query, kind) ‚Üí matching records
- route(record) ‚Üí destinations[]
```

### 4. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏
```sql
deliveries(record_id, route_id, connector, target, idempotency_key, status)
```

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—É—é —Å—Ö–µ–º—É –≤ Supabase
psql -f supabase-schema.sql
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# .env
TELEGRAM_BOT_TOKEN=your_bot_token
OPENAI_API_KEY=your_openai_key
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_key
GOOGLE_SHEETS_CLIENT_EMAIL=your_service_account@gmail.com
GOOGLE_SHEETS_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
```

### 4. –ó–∞–ø—É—Å–∫
```bash
# –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
npm start

# –ò–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev

# –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
npm run legacy
```

## üîß –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ app.js              # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.js     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î
‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îî‚îÄ‚îÄ index.js        # LLM –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ routing.js      # Rules engine
‚îú‚îÄ‚îÄ connectors/
‚îÇ   ‚îú‚îÄ‚îÄ telegram.js     # Telegram DM/–∫–∞–Ω–∞–ª—ã
‚îÇ   ‚îî‚îÄ‚îÄ google.js       # Sheets/Calendar
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ *.test.js       # –¢–µ—Å—Ç—ã
```

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞:
```sql
INSERT INTO routes (tenant_id, name, priority, match, action) VALUES (
  'tenant-uuid',
  '–ë–æ–ª—å—à–∏–µ —Ä–∞—Å—Ö–æ–¥—ã ‚Üí –±—É—Ö–≥–∞–ª—Ç–µ—Ä',
  10,
  '{"kind": "expense", "amount": {">": 10000}}',
  '[
    {"connector": "telegram_dm", "target": "@accountant"},
    {"connector": "google_sheets", "target": "sheet_id!BigExpenses"}
  ]'
);
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã:
```sql
INSERT INTO team_members (tenant_id, display_name, aliases, tg_chat_id) VALUES (
  'tenant-uuid',
  '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤', 
  '["–∏–≤–∞–Ω", "–≤–∞–Ω—è", "ivan"]',
  '@ivan_telegram'
);
```

### API –∑–∞–ø—Ä–æ—Å—ã:
```javascript
// –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π
GET /api/search?tenant_id=uuid&query=–ø—Ä–æ–¥—É–∫—Ç—ã&kind=expense

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
GET /api/records?tenant_id=uuid&kind=task&limit=10
```

## üîç –û—Ç–ª–∏—á–∏—è –æ—Ç v1.0

| –ê—Å–ø–µ–∫—Ç | v1.0 (—Å—Ç–∞—Ä—ã–π) | v2.0 (–Ω–æ–≤—ã–π) |
|--------|---------------|--------------|
| –î–∞–Ω–Ω—ã–µ | –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è `records` |
| –†–æ—É—Ç–∏–Ω–≥ | –•–∞—Ä–¥–∫–æ–¥ –≤ –∫–æ–¥–µ | Rule-based —á–µ—Ä–µ–∑ –ë–î |
| LLM | –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–º–ø—Ç—ã | Function calling + tools |
| –î–æ—Å—Ç–∞–≤–∫–∏ | –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å |
| –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å | –ù–µ—Ç | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| –ü–æ–∏—Å–∫ | SQL –∑–∞–ø—Ä–æ—Å—ã | Full-text + pgvector |

## üéØ Roadmap

### Phase 1 (MVP)
- [x] –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å records
- [x] Rule-based —Ä–æ—É—Ç–∏–Ω–≥
- [x] LLM tools –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [x] –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã

### Phase 2 (Premium)
- [ ] MCP —Å–µ—Ä–≤–µ—Ä—ã –ø–æ–≤–µ—Ä—Ö tools
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- [ ] –ë–æ–ª—å—à–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤ (Notion, Todoist)
- [ ] Webhook'–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

### Phase 3 (Custom)
- [ ] Visual rule builder
- [ ] Custom –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ API
- [ ] Enterprise SSO
- [ ] On-premise —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

## ü§ù –ú–∏–≥—Ä–∞—Ü–∏—è —Å v1.0

1. –°–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ö–µ–º—É –ë–î
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `npm run migrate`
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é: `npm run dev`
5. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å: –∏–∑–º–µ–Ω–∏—Ç—å `main` –≤ package.json

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ üöÄ