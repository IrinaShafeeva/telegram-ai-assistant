# Локальное тестирование бота

Этот файл содержит инструкции по настройке локального тестирования бота без деплоя на сервер.

## ⚠️ ВАЖНО: Конфликт с серверным ботом

Если бот уже запущен на сервере, **НЕЛЬЗЯ** одновременно запускать локальную версию с тем же токеном!

### Решения:

1. **Остановить серверный бот** (рекомендуется для тестирования)
2. **Использовать тестовый токен** (создать нового бота через @BotFather)
3. **Безопасное переключение режимов**

## Быстрый старт

### 1. Безопасная настройка

```bash
# Проверить текущую конфигурацию и безопасность
npm run safe:test

# Создать файл .env из шаблона
npm run setup:local

# Отредактировать .env файл с вашими данными
```

### 2. Переключение режимов

```bash
# Переключить в polling режим (для локального тестирования)
npm run mode:polling

# Переключить в webhook режим (для продакшена)
npm run mode:webhook
```

### 3. Запуск локального тестирования

```bash
# Запуск в режиме разработки с автоперезагрузкой
npm run local

# Или запуск в продакшн режиме (без автоперезагрузки)
npm run local:prod
```

### 3. Проверка работы

После запуска бот будет работать в режиме polling (опрос сервера Telegram). Проверьте:

1. Откройте Telegram и найдите вашего бота
2. Отправьте команду `/start`
3. Проверьте логи в консоли

## Режимы работы

### Development режим
- Автоперезагрузка при изменении файлов
- Подробные логи
- `NODE_ENV=development`

### Production режим
- Без автоперезагрузки
- Оптимизированные логи
- `NODE_ENV=production`

## Конфигурация

### Обязательные переменные окружения:

```env
# Telegram Bot
BOT_TOKEN=your_bot_token

# Supabase Database
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key

# OpenAI
OPENAI_API_KEY=your_openai_api_key
```

### Опциональные переменные:

```env
# Google Sheets (если используете)
GOOGLE_SHEETS_CREDENTIALS_PATH=./ai-assistant-sheets-ddaae7505964.json

# Сервер
PORT=3000
LOG_LEVEL=info
```

## Полезные команды

```bash
# Проверить статус бота
curl http://localhost:3000/

# Проверить подключение к Telegram
curl http://localhost:3000/test-bot

# Просмотр логов в реальном времени
npm run local | tee bot.log
```

## Отладка

### Проблемы с подключением к Telegram:
1. Проверьте правильность BOT_TOKEN
2. Убедитесь, что бот не запущен на другом сервере
3. Проверьте интернет-соединение

### Проблемы с базой данных:
1. Проверьте SUPABASE_URL и SUPABASE_ANON_KEY
2. Убедитесь, что таблицы созданы в Supabase
3. Проверьте права доступа к базе данных

### Проблемы с OpenAI:
1. Проверьте OPENAI_API_KEY
2. Убедитесь, что у вас есть доступ к API
3. Проверьте баланс аккаунта OpenAI

## Структура файлов

```
├── src/
│   ├── bot/           # Логика бота
│   ├── services/      # Сервисы (Supabase, OpenAI, Google Sheets)
│   ├── utils/         # Утилиты
│   └── index.js       # Главный файл
├── local-test.env     # Шаблон конфигурации
├── package.json       # Скрипты и зависимости
└── LOCAL_TESTING.md   # Этот файл
```

## Безопасность

⚠️ **ВАЖНО**: Никогда не коммитьте файл `.env` в git!

Добавьте в `.gitignore`:
```
.env
.env.local
.env.production
```

## Производство vs Локальная разработка

| Аспект | Локально | На сервере |
|--------|----------|------------|
| Режим | Polling | Webhook |
| Перезагрузка | Автоматическая | Ручная |
| Логи | Консоль | Файлы |
| Конфигурация | .env | Переменные окружения |

## Следующие шаги

1. Настройте локальное окружение
2. Протестируйте основные функции
3. Внесите изменения в код
4. Протестируйте изменения локально
5. Задеплойте на сервер только после успешного тестирования
